# Feature 03: Output Metadata Tracking

## Status
ðŸ”´ Not Started

## Overview
Create an `output-metadata.yaml` file that tracks what cards have been processed and extracted for each team. This provides an inventory/manifest of the output folder, making it easy to see what content is available for each team.

**Note:** This is separate from `config/team-name-mapping.yaml`, which remains a simple name normalization config file.

## Current State
- `config/team-name-mapping.yaml` - Simple name aliases (keep as-is)
- No metadata file tracking processed output
- No easy way to see what cards each team has
- No inventory of operative names, ploy names, faction rules

## Proposed Structure: `output-metadata.yaml`

```yaml
# Generated metadata tracking processed output
# Auto-generated by pipeline after extraction
# Last updated: 2026-01-10

teams:
  angels-of-death:
    # Identity
    canonical_name: "Angels of Death"
    faction: "Imperium"
    subfaction: "Space Marines"
    
    # Processing Status
    last_processed: "2026-01-10T15:30:00"
    source_pdfs:
      - "angels-of-death-datacards.pdf"
      - "angels-of-death-equipment.pdf"
      - "angels-of-death-faction-rules.pdf"
      - "angels-of-death-firefight-ploys.pdf"
      - "angels-of-death-operatives.pdf"
      - "angels-of-death-strategy-ploys.pdf"
    
    # Card Content Inventory
    datacards:
      count: 8
      cards:
        - name: "Assault Intercessor Grenadier"
        - name: "Assault Intercessor Sergeant"
        - name: "Intercessor Gunner"
        - name: "Intercessor Warrior"
        - name: "Assault Intercessor Warrior"
        - name: "Heavy Intercessor"
        - name: "Infiltrator"
        - name: "Reiver"
    
    equipment:
      count: 12
      cards:
        - name: "Auspex"
        - name: "Combat Blade"
        - name: "Grav-Chute"
        - name: "Krak Grenade"
        - name: "Auxiliary Grenade Launcher"
        # ... etc
    
    faction-rules:
      count: 2
      cards:
        - name: "Astartes"
        - name: "Chapter Tactics"
    
    ploys:
      firefight:
        count: 6
        cards:
          - name: "Shock Assault"
            description: "Use this Strategic Ploy when activating an operative. Until the end of that operative's activation, each time it fights in combat, in the Resolve Successful Hits step of that combat, your opponent can only parry with one dice."
          - name: "Death to the Traitors"
            description: "..."
          - name: "Armour of Contempt"
            description: "..."
          - name: "Covering Fire"
            description: "..."
          - name: "Storm of Fire"
            description: "..."
          - name: "Transhuman Physiology"
            description: "..."
      
      strategy:
        count: 8
        cards:
          - name: "And They Shall Know No Fear"
            description: "..."
          - name: "Bolter Discipline"
            description: "..."
          - name: "Combat Squads"
            description: "..."
          - name: "Honor the Chapter"
            description: "..."
          - name: "Fury of the First"
            description: "..."
          - name: "Rapid Redeployment"
            description: "..."
          - name: "Angels of Death"
            description: "..."
          - name: "Blade Masters"
            description: "..."
    
    operative_selection:
      total: 10
      options:
        - name: "Assault Intercessor Sergeant"
          max: 1
          mandatory: true
        - name: "Assault Intercessor Grenadier"
          max: 1
        - name: "Intercessor Gunner"
          max: 2
        - name: "Heavy Intercessor"
          max: 1
        - name: "Infiltrator"
          max: 1
        - name: "Reiver"
          max: 1
        - name: "Assault Intercessor Warrior"
          max: 9  # Fill remaining slots
        - name: "Intercessor Warrior"
          max: 9  # Fill remaining slots
      notes: "You must select 1 ASSAULT INTERCESSOR SERGEANT (Leader) and 9 other operatives from the list above. You can select up to 2 INTERCESSOR GUNNER operatives and any number of WARRIOR operatives."
    
    # Summary
    total_cards: 37
    complete: true
    
  kasrkin:
    canonical_name: "Kasrkin"
    faction: "Imperium"
    subfaction: "Astra Militarum"
    
    last_processed: "2026-01-10T14:20:00"
    source_pdfs:
      - "kasrkin-datacards.pdf"
      - "kasrkin-equipment.pdf"
      - "kasrkin-faction-rules.pdf"
      - "kasrkin-firefight-ploys.pdf"
      - "kasrkin-operatives.pdf"
      - "kasrkin-strategy-ploys.pdf"
    
    datacards:
      count: 10
      cards:
        - name: "Kasrkin Trooper"
        - name: "Kasrkin Gunner"
        - name: "Kasrkin Sergeant"
        - name: "Kasrkin Marksman"
        - name: "Kasrkin Demolitions Expert"
        - name: "Kasrkin Comms Operative"
        - name: "Kasrkin Medic"
        - name: "Kasrkin Vox-Caster"
        - name: "Kasrkin Spotter"
        - name: "Kasrkin Heavy Gunner"
    
    equipment:
      count: 8
      cards:
        - name: "Hot-shot Lasgun"
        - name: "Plasma Gun"
        - name: "Meltagun"
        - name: "Grenade Launcher"
        - name: "Frag Grenade"
        - name: "Krak Grenade"
        - name: "Medi-pack"
        - name: "Vox-caster"
    
    faction-rules:
      count: 1
      cards:
        - name: "Skill at Arms"
    
    ploys:
      firefight:
        count: 4
        cards:
          - name: "Volley Fire"
            description: "..."
          - name: "Stand Firm"
            description: "..."
          - name: "Overwhelming Firepower"
            description: "..."
          - name: "Rapid Advance"
            description: "..."
      
      strategy:
        count: 6
        cards:
          - name: "Disciplined Fire"
            description: "Use this Tactical Ploy when activating an operative. Until the end of that operative's activation, each time it performs a shooting attack, you can re-roll one of your attack dice."
          - name: "Tactical Withdrawal"
            description: "..."
          - name: "Concentrated Fire"
            description: "..."
          - name: "Take Aim"
            description: "..."
          - name: "Shock Troops"
            description: "..."
          - name: "Elite Guard"
            description: "..."
    
    operative_selection:
      total: 10
      options:
        - name: "Kasrkin Sergeant"
          max: 1
          mandatory: true
        - name: "Kasrkin Marksman"
          max: 1
        - name: "Kasrkin Demolitions Expert"
          max: 1
        - name: "Kasrkin Comms Operative"
          max: 1
        - name: "Kasrkin Medic"
          max: 1
        - name: "Kasrkin Vox-Caster"
          max: 1
        - name: "Kasrkin Spotter"
          max: 1
        - name: "Kasrkin Gunner"
          max: 2
        - name: "Kasrkin Heavy Gunner"
          max: 1
        - name: "Kasrkin Trooper"
          max: 9  # Fill remaining slots
      notes: "You must select 1 KASRKIN SERGEANT (Leader) and 9 other operatives. You can select up to 2 KASRKIN GUNNER operatives and any number of KASRKIN TROOPER operatives."
    
    total_cards: 30
    complete: true
  
  hearthkyn-salvager:
    canonical_name: "Hearthkyn Salvager"
    faction: "Xenos"
    subfaction: "Leagues of Votann"
    
    last_processed: "2026-01-10T14:00:00"
    source_pdfs:
      - "hearthkyn-salvager-datacards.pdf"
      - "hearthkyn-salvager-equipment.pdf"
      - "hearthkyn-salvager-faction-rules.pdf"
      - "hearthkyn-salvager-operatives.pdf"
    
    operative_selection:
      total: 10
      options:
        - name: "Hearthkyn Salvager Theyn"
          max: 1
          mandatory: true
        - name: "Hearthkyn Salvager Dozr"
          max: 1
        - name: "Hearthkyn Salvager Field Medic"
          max: 1
        - name: "Hearthkyn Salvager Grenadier"
          max: 1
        - name: "Hearthkyn Salvager Gunner"
          max: 3
        - name: "Hearthkyn Salvager Comms"
          max: 1
        - name: "Hearthkyn Salvager Scanner"
          max: 1
        - name: "Hearthkyn Salvager Marksman"
          max: 1
        - name: "Hearthkyn Salvager Warrior"
          max: 9  # Fill remaining slots
      notes: "You must select 1 HEARTHKYN SALVAGER THEYN (Leader) and 9 other HEARTHKYN SALVAGER operatives. You can select up to 3 HEARTHKYN SALVAGER GUNNER operatives and any number of HEARTHKYN SALVAGER WARRIOR operatives. Each other operative can be selected once."
    
    total_cards: 15
    complete: false  # Missing some card types
  
  # ... more teams
```

## Features to Track

### 1. Team Identity
- **canonical_name**: Official display name for the team
- **faction**: Primary faction (Imperium, Chaos, Xenos, etc.)
- **subfaction**: Sub-faction or army (Space Marines, Astra Militarum, etc.)

### 2. Card Inventory
For each card type, track:
- **count** or **total**: Number of cards/options of this type
- **cards**: List of card names with descriptions
  - **name**: Extracted from image filenames (e.g., `assault-intercessor-grenadier_front.jpg`), convert kebab-case to Title Case
  - **description**: Text copied from the card (initially "..." placeholder, filled in manually or via OCR)

### 3. Ploys Structure (Grouped)
Ploys are grouped together with firefight and strategy subsections:
- **ploys**: Top-level grouping
  - **firefight**: Firefight ploys with count and cards (with descriptions)
  - **strategy**: Strategy ploys with count and cards (with descriptions)
- This replaces the previous separate `firefight-ploys` and `strategy-ploys` sections
- Better readability and logical grouping

### 4. Operative Selection (Special Case)
Operative selection is tracked differently as it represents roster building rules:
- **total**: Total number of operative slots (e.g., 10)
- **options**: List of operative choices with constraints:
  - **name**: Operative type name
  - **max**: Maximum number that can be selected (actual number, not null)
  - **mandatory**: Boolean indicating if this operative must be selected
- **notes**: Text copied from the operative card explaining selection rules
  - Captures special rules, weapon options info, limitations
- Note: `datacards` will contain the actual operative datacards with stats (different from selection rules)

### 5. Processing Information
- **last_processed**: ISO timestamp of when this team was last processed
- **source_pdfs**: List of source PDF filenames in processed/ folder
- **total_cards**: Sum of all cards across all types
- **complete**: Boolean indicating if all expected card types are present

### 6. Card Types Tracked
- `datacards` - Individual operative datacards (will contain stats in future)
- `equipment` - Equipment cards with descriptions
- `faction-rules` - Faction rule cards (simple list for now)
- `ploys` - **Grouped structure** containing:
  - `firefight` - Firefight ploys with descriptions
  - `strategy` - Strategy ploys with descriptions
- `operative_selection` - **Special structure** with roster building rules (total, options, constraints, notes)

## Implementation Steps

### Phase 1: Metadata Generator
- [ ] Create `OutputMetadataGenerator` class
- [ ] Scan `output/` directory structure
- [ ] Extract card names from filenames
- [ ] Count cards per type per team
- [ ] Generate YAML structure

### Phase 2: Card Name Extraction
- [ ] Parse image filenames to get card names
- [ ] Handle `_front.jpg` and `_back.jpg` suffixes
- [ ] Convert kebab-case to Title Case (e.g., `assault-intercessor-grenadier` â†’ `Assault Intercessor Grenadier`)
- [ ] Deduplicate (count front/back as one card)

### Phase 3: Operative Selection Special Handling
- [ ] Parse operative selection card images (OCR or manual input initially)
- [ ] Extract operative option names and constraints
- [ ] Identify mandatory operatives (usually leader)
- [ ] Determine max counts for each operative type
- [ ] Extract notes/rules text from card
- [ ] Handle weapon options markers (*, etc.) by including in notes

### Phase 4: Card Descriptions
- [ ] For ploys and equipment, add description field
- [ ] Initially populate with "..." placeholder
- [ ] Support manual entry or OCR extraction of card text
- [ ] Descriptions help with search and validation

### Phase 4: Card Descriptions
- [ ] For ploys and equipment, add description field
- [ ] Initially populate with "..." placeholder
- [ ] Support manual entry or OCR extraction of card text
- [ ] Descriptions help with search and validation

### Phase 5: Faction/Subfaction Detection
- [ ] Create faction mapping (manual or auto-detect)
- [ ] Infer faction from team name patterns where possible
- [ ] Allow manual override in config

### Phase 6: Auto-Generation on Pipeline Run
- [ ] Integrate metadata generation into pipeline
- [ ] Generate/update `output-metadata.yaml` after extraction step
- [ ] Update timestamps automatically
- [ ] Preserve manual edits (faction/subfaction, descriptions)

### Phase 7: Metadata Reader Utility
- [ ] Create helper class to read metadata
- [ ] Query methods: `get_team()`, `get_all_teams()`, `get_cards_by_type()`
- [ ] Filter methods: `teams_by_faction()`, `incomplete_teams()`

### Phase 8: Reporting & Validation
- [ ] Create status report script
- [ ] Show team completeness (missing card types)
- [ ] List all available content
- [ ] Validate output/ matches metadata

## Usage Examples

### Generating Metadata
```python
from src.generators.metadata_generator import OutputMetadataGenerator

generator = OutputMetadataGenerator(output_dir='output')
metadata = generator.generate()
generator.save('output-metadata.yaml')
```

### Reading Metadata
```python
from src.utils.metadata_reader import OutputMetadata

metadata = OutputMetadata.load('output-metadata.yaml')

# Get team info
team = metadata.get_team('kasrkin')
print(team['canonical_name'])  # "Kasrkin"
print(team['faction'])  # "Imperium"
print(team['total_cards'])  # 30

# Get card list
datacards = team['datacards']['cards']
for card in datacards:
    print(card['name'])  # "Kasrkin Trooper", etc.

# Query across teams
imperium_teams = metadata.teams_by_faction('Imperium')
incomplete = metadata.incomplete_teams()
```

### Status Report
```bash
python script/generate_status_report.py

# Output:
=== Team Inventory Report ===

Angels of Death (Imperium / Space Marines)
  Last Processed: 2026-01-10 15:30
  Total Cards: 37
  âœ“ datacards (8 cards)
  âœ“ equipment (12 cards)
  âœ“ faction-rules (2 cards)
  âœ“ firefight-ploys (6 cards)
  âœ“ operatives (1 card)
  âœ“ strategy-ploys (8 cards)

Kasrkin (Imperium / Astra Militarum)
  Last Processed: 2026-01-10 14:20
  Total Cards: 30
  âœ“ datacards (10 cards)
  âœ“ equipment (8 cards)
  âœ“ faction-rules (1 card)
  âœ“ firefight-ploys (4 cards)
  âœ“ operatives (1 card)
  âœ“ strategy-ploys (6 cards)

Total Teams: 13
Total Cards: 342
```

## Benefits

### 1. Quick Overview
- See all available content at a glance
- Know what cards each team has
- Identify missing or incomplete teams

### 2. Content Discovery
- Find specific cards across teams
- List all operatives, ploys, equipment by team
- Search for specific card names

### 3. Validation
- Verify output/ folder contents match expectations
- Detect missing or extra files
- Ensure all card types are present

### 4. Documentation
- Auto-generated inventory of all processed content
- Easy reference for TTS deck building
- Historical record of what's been processed

## Notes

- File is auto-generated - manual edits to faction/subfaction should be preserved
- Card names extracted from filenames (may need manual cleanup for special characters)
- Metadata generation should be idempotent (running twice produces same result)
- File should be committed to git to track content changes over time
- Consider adding to .gitignore if too much churn, but recommended to track it

## Related Features

- **Feature 04**: Stats extraction could add card stats to this metadata
- **Feature 05**: Parameterized execution could use this to filter by faction/subfaction
